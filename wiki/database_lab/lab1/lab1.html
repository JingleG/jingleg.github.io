<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>6.830 lab：lab1 - Jingle</title>

  
    <meta name="description" content="lab1 需要完成一下几个部分  Tuple, TupleDesc Catalog BufferPool HeapPage, HeapFile SeqScan  先看看都有什么 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960">
<meta property="og:type" content="website">
<meta property="og:title" content="lab1">
<meta property="og:url" content="https://jingleg.github.io/wiki/database_lab/lab1/lab1.html">
<meta property="og:site_name" content="Jingle">
<meta property="og:description" content="lab1 需要完成一下几个部分  Tuple, TupleDesc Catalog BufferPool HeapPage, HeapFile SeqScan  先看看都有什么 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jingleg.github.io/wiki/database_lab/lab1/lab1.jpg">
<meta property="article:published_time" content="2023-09-13T16:15:38.244Z">
<meta property="article:modified_time" content="2023-09-13T16:15:38.244Z">
<meta property="article:author" content="Jingle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jingleg.github.io/wiki/database_lab/lab1/lab1.jpg">
  
  
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  

  


  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='wiki'>
    

  




<div class="widgets"><widget class="widget-wrapper logo-wrap wiki"><div class="widget-body"><a style="filter: grayscale(100%)" class="wiki-home cap" href="/wiki"><svg aria-hidden="true" viewBox="0 0 16 16" width="1rem" height="1rem" fill="currentColor"><path fill-rule="evenodd" d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"></path></svg>所有项目</a><a class="title" href="/wiki/database_lab/index.html"><div class="main" ff="title">6.830 lab</div></a></div></widget>

<widget class="widget-wrapper toc multi" id="data-toc"><div class="widget-header cap dis-select"><span class="name">lab1</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/database_lab/index.html#start"><span class="toc-text">Intro</span></a></div><a class="anchor" id="default"></a><div class="doc-tree active"><a class="doc-tree-link active" href="/wiki/database_lab/lab1/lab1.html#default"><span class="toc-text">lab1</span></a><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-1"><span class="toc-text">Exercise 1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TupleDesc"><span class="toc-text">TupleDesc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tuple"><span class="toc-text">Tuple</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-2"><span class="toc-text">Exercise 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-3"><span class="toc-text">Exercise 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-4"><span class="toc-text">Exercise 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-5"><span class="toc-text">Exercise 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-6"><span class="toc-text">Exercise 6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/database_lab/lab2/lab2.html#default"><span class="toc-text">lab2</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/database_lab/lab3/lab3.html#default"><span class="toc-text">lab3</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/database_lab/lab4/lab4.html#default"><span class="toc-text">lab4</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/database_lab/lab5/lab5.html#default"><span class="toc-text">lab5</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/database_lab/lab6/lab6.html#default"><span class="toc-text">lab6</span></a></div></div></widget>

<widget class="widget-wrapper recent"><div class="widget-header cap theme dis-select"><span class="name">最近更新</span></div><div class="widget-body related-posts fs14"><a class="item title" href="/wiki/database_lab/lab3/lab3.html"><span class="title"><strong>6.830 lab</strong><span class="dot"></span>lab3</span></a><a class="item title" href="/wiki/algorithm/math/divisor.html"><span class="title"><strong>算法 in Java</strong><span class="dot"></span>Divisor 约数</span></a><a class="item title" href="/wiki/algorithm/math/matrix.html"><span class="title"><strong>算法 in Java</strong><span class="dot"></span>Matrix 矩阵</span></a><a class="item title" href="/wiki/database_lab/lab1/lab1.html"><span class="title"><strong>6.830 lab</strong><span class="dot"></span>lab1</span></a><a class="item title" href="/wiki/database_lab/lab2/lab2.html"><span class="title"><strong>6.830 lab</strong><span class="dot"></span>lab2</span></a></div></widget>
</div>


    </aside>
    <div class='l_main'>
      

      

  
  
  
  
<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" id="home" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">项目</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/database_lab/index.html">6.830 lab</a></div><div id="post-meta">更新于&nbsp;<time datetime="2023-09-13T16:15:38.244Z">2023-09-13</time></div></div>

  <article class='md-text content wiki'>
  <h1 class="article-title" ><span>lab1</span></h1>
  <p>lab1 需要完成一下几个部分</p>
<ul>
<li>Tuple, TupleDesc</li>
<li>Catalog</li>
<li>BufferPool</li>
<li>HeapPage, HeapFile</li>
<li>SeqScan</li>
</ul>
<p>先看看都有什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">simpledb</span><br><span class="line">│  Parser.java</span><br><span class="line">│  ParsingException.java</span><br><span class="line">│  SimpleDb.java</span><br><span class="line">│</span><br><span class="line">├─common</span><br><span class="line">│      Catalog.java</span><br><span class="line">│      Database.java</span><br><span class="line">│      DbException.java</span><br><span class="line">│      DeadlockException.java</span><br><span class="line">│      Debug.java</span><br><span class="line">│      Permissions.java</span><br><span class="line">│      Type.java</span><br><span class="line">│      Utility.java</span><br><span class="line">│</span><br><span class="line">├─execution</span><br><span class="line">│      Aggregate.java</span><br><span class="line">│      Aggregator.java</span><br><span class="line">│      Delete.java</span><br><span class="line">│      Filter.java</span><br><span class="line">│      HashEquiJoin.java</span><br><span class="line">│      IndexOpIterator.java</span><br><span class="line">│      IndexPredicate.java</span><br><span class="line">│      Insert.java</span><br><span class="line">│      IntegerAggregator.java</span><br><span class="line">│      Join.java</span><br><span class="line">│      JoinPredicate.java</span><br><span class="line">│      Operator.java</span><br><span class="line">│      OpIterator.java</span><br><span class="line">│      OrderBy.java</span><br><span class="line">│      PlanCache.java</span><br><span class="line">│      Predicate.java</span><br><span class="line">│      Project.java</span><br><span class="line">│      Query.java</span><br><span class="line">│      SeqScan.java</span><br><span class="line">│      StringAggregator.java</span><br><span class="line">│</span><br><span class="line">├─index</span><br><span class="line">│      BTreeChecker.java</span><br><span class="line">│      BTreeEntry.java</span><br><span class="line">│      BTreeFile.java</span><br><span class="line">│      BTreeFileEncoder.java</span><br><span class="line">│      BTreeHeaderPage.java</span><br><span class="line">│      BTreeInternalPage.java</span><br><span class="line">│      BTreeLeafPage.java</span><br><span class="line">│      BTreePage.java</span><br><span class="line">│      BTreePageId.java</span><br><span class="line">│      BTreeRootPtrPage.java</span><br><span class="line">│      BTreeScan.java</span><br><span class="line">│      BTreeUtility.java</span><br><span class="line">│</span><br><span class="line">├─optimizer</span><br><span class="line">│      CostCard.java</span><br><span class="line">│      IntHistogram.java</span><br><span class="line">│      JoinOptimizer.java</span><br><span class="line">│      LogicalFilterNode.java</span><br><span class="line">│      LogicalJoinNode.java</span><br><span class="line">│      LogicalPlan.java</span><br><span class="line">│      LogicalScanNode.java</span><br><span class="line">│      LogicalSelectListNode.java</span><br><span class="line">│      LogicalSubplanJoinNode.java</span><br><span class="line">│      OperatorCardinality.java</span><br><span class="line">│      QueryPlanVisualizer.java</span><br><span class="line">│      StringHistogram.java</span><br><span class="line">│      TableStats.java</span><br><span class="line">│</span><br><span class="line">├─storage</span><br><span class="line">│      AbstractDbFileIterator.java</span><br><span class="line">│      BufferPool.java</span><br><span class="line">│      DbFile.java</span><br><span class="line">│      DbFileIterator.java</span><br><span class="line">│      Field.java</span><br><span class="line">│      HeapFile.java</span><br><span class="line">│      HeapFileEncoder.java</span><br><span class="line">│      HeapPage.java</span><br><span class="line">│      HeapPageId.java</span><br><span class="line">│      IntField.java</span><br><span class="line">│      LogFile.java</span><br><span class="line">│      Page.java</span><br><span class="line">│      PageId.java</span><br><span class="line">│      RecordId.java</span><br><span class="line">│      StringField.java</span><br><span class="line">│      Tuple.java</span><br><span class="line">│      TupleDesc.java</span><br><span class="line">│      TupleIterator.java</span><br><span class="line">│</span><br><span class="line">└─transaction</span><br><span class="line">        Transaction.java</span><br><span class="line">        TransactionAbortedException.java</span><br><span class="line">        TransactionId.java</span><br></pre></td></tr></table></figure>

<p>首先需要关注的：</p>
<ul>
<li><code>Database.java</code>：提供catalog（库中表的信息），buffer pool，log</li>
<li><code>StringField</code> &amp; <code>IntField</code>： 唯二的两个数据类型</li>
<li><code>Tuple</code>：数据行，包含多个<code>Field</code></li>
<li><code>TupleDesc</code>：表头，tuple descriptor</li>
<li><code>TupleIterator</code>：Tuple 游标，用于遍历tuple list</li>
</ul>
<h2 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h2><p>Implement <code>TupleDesc.java</code> &amp; <code>Tuple.java</code><br>观察一下，从表头开始写，因为 Tuple 中需要用到 TupleDesc。</p>
<h3 id="TupleDesc"><a href="#TupleDesc" class="headerlink" title="TupleDesc"></a>TupleDesc</h3><p>实现<a class="tag-plugin tag" color="yellow" target="_blank" rel="noopener" href="https://github.com/JingleG/6.830-java/blob/lab1/src/java/simpledb/storage/TupleDesc.java">TupleDesc</a>：用给定内部类 <code>TDItem</code> 来存表头的字段信息，包含 <code>type</code> 和 <code>name</code>。<br>坑：</p>
<ul>
<li>求单行所占用的数据大小 size 的具体数值在 <code>Type.getLen()</code> 提供</li>
<li>给的 fieldAr 数组中的表头名可能为 null, <code>equals()</code> 需要特判</li>
</ul>
<h3 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h3><p>实现 <a class="tag-plugin tag" color="yellow" target="_blank" rel="noopener" href="https://github.com/JingleG/6.830-java/blob/lab1/src/java/simpledb/storage/Tuple.java">Tuple</a>：创建 Field 数组用于存储数据</p>
<blockquote>
<p>modifyRecordId 暂时会 fail，不影响</p>
</blockquote>
<h2 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h2><p>实现 <a class="tag-plugin tag" color="yellow" target="_blank" rel="noopener" href="https://github.com/JingleG/6.830-java/blob/lab1/src/java/simpledb/common/Catalog.java">Catalog</a></p>
<p>根据描述， <code>Catalog</code> 存储了所有表的信息，包含表的物理存储文件 <code>DbFile</code> 以及主键信息 <code>pkeyField</code>。</p>
<p>实现：4 * HashMap，维护 name, id, file, pk 的映射</p>
<h2 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h2><p>Implement <code>getPage()</code> in  <a class="tag-plugin tag" color="yellow" target="_blank" rel="noopener" href="https://github.com/JingleG/6.830-java/blob/lab1/src/java/simpledb/storage/BufferPool.java">BufferPool</a></p>
<p>这里要求从 <code>BufferPool</code> 中返回 <code>PageId</code> 对应的 <code>page</code>，如果没有就要把 <code>page</code> 从 disk 上读出来放到 pool 中。对于没有的 <code>page</code>，代码里没有明说从哪里读，但是从前面的部分可以推测肯定是从 <code>DbFile</code> 中读取，因为 <code>DbFile</code> 存着表的数据。</p>
<p>观察 <code>Catalog</code> 以及 <code>PageId</code>，可以发现 <code>PageId</code> 包含了 <code>tableId</code> 而 <code>Catalog</code> 维护了 <code>tableId</code> 到物理文件 <code>DbFile</code> 的映射。再看 <code>DbFile</code>，里面也提供了需要的 <code>Page readPage(PageId id)</code>。</p>
<p>剩下的没啥好说的，直接从 <code>Catalog</code> 用 <code>tableId</code> 拿到 <code>DbFile</code>，再用 <code>readPage</code> 把 <code>page</code> 读进来丢到 HashMap 里即可。 这部分要求如果满了就抛 <code>DbException</code>，不需要 eviction policy。</p>
<p>唯一不确定的就是 BufferPool 被标记为 <code>@ThreadSafe</code>，不知道需不需要用 <code>ConcurrentHashMap</code>。</p>
<h2 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h2><p>Implement <code>HeapPageId.java</code>, <code>RecordId.java</code>, <code>HeapPage.java</code></p>
<p>完成 <a class="tag-plugin tag" color="yellow" target="_blank" rel="noopener" href="https://github.com/JingleG/6.830-java/blob/lab1/src/java/simpledb/storage/HeapPage.java">HeapPage</a>及相关的基本操作</p>
<ul>
<li><strong>HeapPageId</strong>：存 <code>tableId</code> 和 <code>pgNo</code>, 假设<code>MAX_PAGES_PER_TABLE = 100000</code> 计算 <code>hashCode()</code>。</li>
<li><strong>RecordId</strong>：存 <code>PageId</code> 和 <code>tupleNo</code>, 假设<code>MAX_TUPLES_PER_PAGE = 10000</code> 计算 <code>hashCode()</code>。</li>
<li><strong>HeapPage</strong>：由 <code>header[]</code> 和 <code>tuples[]</code> 构成，其中 <code>header</code> 为 bitmap，标记对应 slot 是否有数据，<code>tuples[]</code> 则存储具体数据。</li>
</ul>
<p>其中稍微复杂的部分是计算 header 部分，但 lab 代码中已经给出了计算公式，位运算直接照抄即可，具体对应方法为 Big-endian。</p>
<blockquote>
<p>The low (least significant) bits of each byte represents the status of the slots that are earlier in the file. Hence, the lowest bit of the first byte represents whether or not the first slot in the page is in use. The second lowest bit of the first byte represents whether or not the second slot in the page is in use, and so on. Also, note that the high-order bits of the last byte may not correspond to a slot that is actually in the file, since the number of slots may not be a multiple of 8.<br><code>tuples per page = floor((BufferPool.getPageSize()*8) / (tuple size * 8 + 1))</code><br><code>header bytes = ceiling(tuples per page / 8)</code></p>
</blockquote>
<h2 id="Exercise-5"><a href="#Exercise-5" class="headerlink" title="Exercise 5"></a>Exercise 5</h2><p>Implement <a class="tag-plugin tag" color="yellow" target="_blank" rel="noopener" href="https://github.com/JingleG/6.830-java/blob/lab1/src/java/simpledb/storage/HeapFile.java">HeapFile</a></p>
<p>这部分需要实现存储实际数据的 DbFile 读取操作，lab 代码中空空如也，不过好在 instruction 中有所提示。</p>
<p>先是 <code>ReadPage(PageId pid)</code>，是从 DbFile 中读取指定的 Page。</p>
<blockquote>
<p>To read a page from disk, you will first need to calculate the correct offset in the file. <strong>Hint</strong>: you will need random access to the file in order to read and write pages at arbitrary offsets. You should not call <code>BufferPool</code> instance methods when reading a page from disk.</p>
</blockquote>
<p>关键词: random access, offset 暗示使用 RandomAccessFile 来从指定 offset 来读取 byte 数组，读取后创建新的 HeapPage 返回即可。不知道给的 PageId 是不是 HeapPageId，保险起见没有强转。</p>
<p>然后是 <code>DbFileIterator</code>，要求迭代当前 DbFile 中所有的 Tuple，并且 Page 必须从 BufferPool 中获取。实现为按顺序获取各个 page 的 iterator，遍历 Tuple。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// see DbFile.java for javadocs</span></span><br><span class="line"><span class="keyword">public</span> DbFileIterator <span class="title function_">iterator</span><span class="params">(TransactionId tid)</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> some code goes here</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DbFileIterator</span>() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">numPages</span> <span class="operator">=</span> numPages();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BufferPool</span> <span class="variable">bufferPool</span> <span class="operator">=</span> Database.getBufferPool();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">tableId</span> <span class="operator">=</span> getId();</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> currentPageNo;</span><br><span class="line">        <span class="keyword">private</span> Iterator&lt;Tuple&gt; pageIter;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException &#123;</span><br><span class="line">            currentPageNo = <span class="number">0</span>;</span><br><span class="line">            pageIter = getIterator();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Tuple&gt; <span class="title function_">getIterator</span><span class="params">()</span> <span class="keyword">throws</span> TransactionAbortedException, DbException &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentPageNo &gt;= numPages) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">HeapPageId</span> <span class="variable">pid</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeapPageId</span>(tableId, currentPageNo);</span><br><span class="line">            <span class="keyword">return</span> ((HeapPage) bufferPool.getPage(tid, pid, Permissions.READ_ONLY)).iterator();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException &#123;</span><br><span class="line">            <span class="keyword">while</span> (pageIter != <span class="literal">null</span> &amp;&amp; !pageIter.hasNext()) &#123;</span><br><span class="line">                currentPageNo++;</span><br><span class="line">                pageIter = getIterator();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> pageIter != <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Tuple <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException, NoSuchElementException &#123;</span><br><span class="line">            <span class="keyword">if</span> (pageIter == <span class="literal">null</span> || !pageIter.hasNext()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">            <span class="type">Tuple</span> <span class="variable">res</span> <span class="operator">=</span> pageIter.next();</span><br><span class="line">            hasNext();</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rewind</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException &#123;</span><br><span class="line">            close();</span><br><span class="line">            open();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">            pageIter = <span class="literal">null</span>;</span><br><span class="line">            currentPageNo = numPages;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Exercise-6"><a href="#Exercise-6" class="headerlink" title="Exercise 6"></a>Exercise 6</h2><p>Implement <a class="tag-plugin tag" color="yellow" target="_blank" rel="noopener" href="https://github.com/JingleG/6.830-java/blob/lab1/src/java/simpledb/execution/SeqScan.java">SeqScan</a></p>
<p>直接使用 DbFile 的 iterator 遍历 file 的所有 tuple 即可。注意 <code>getTupleDesc()</code> 需要更改 fieldName （<code>alias.fieldName</code>）。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>难度：有手就行，仔细看看 lab 的注释 和 instruction 一晚上即可拿下，没啥好说的。</p>
<p>附赠 lab1 一键测试脚本，放入 <code>build.xml</code> 即可，不报错默认通过，使用 IDEA 需要取消 ant 的 make build in background 可以看到测试细节。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">&quot;lab1&quot;</span> <span class="attr">depends</span>=<span class="string">&quot;testcompile&quot;</span> <span class="attr">description</span>=<span class="string">&quot;Run all unit tests&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RunJunit</span> <span class="attr">timeoutMs</span>=<span class="string">&quot;$&#123;timeoutMs&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">batchtest</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">&quot;$&#123;build.test&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/TupleTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/TupleDescTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/CatalogTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/HeapPageIdTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/RecordIDTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/HeapPageReadTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/HeapFileReadTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">&quot;**/systemtest/ScanTest.class&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">&quot;**/*$*.class&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">batchtest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">RunJunit</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">echo</span> <span class="attr">message</span>=<span class="string">&quot;All tests passed successfully!&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>还有当时做lab时画的图，虽然不是很准确，可以拿来参考。</p>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="lab1.jpg" fancybox="true"/></div></div>
  
  


  </article>
  
<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/database_lab/index.html">Intro</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/database_lab/lab2/lab2.html">lab2</a></div></section></div>

  

  <div class='related-wrap md-text reveal' id="comments">
    <section class='header cmt-title cap theme'>
      快来参与讨论吧
    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" data-repo="JingleG/blog-comments" data-repo-id="R_kgDOJ_S-YA" data-category="Announcements" data-category-id="DIC_kwDOJ_S-YM4CYGuh" data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>




      
<footer class="page-footer reveal fs12"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs14">博客</span><a href="/">近期</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs14">项目</span><a href="/wiki/">发现</a></div><div class="sitemap-group"><span class="fs14">社交</span><a href="/talk/">留言板</a></div><div class="sitemap-group"><span class="fs14">更多</span><a href="/about/">关于本站</a><a target="_blank" rel="noopener" href="https://github.com/Jingle">GitHub</a></div></div><div class="text"><p>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> &amp; <a target="_blank" rel="noopener" href="https://giscus.app/">giscus</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/">GitHub</a></p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = stellar.config.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.19.0';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
    root : '/',
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.copycode = Object.assign({"enable":true,"js":"/js/plugins/copycode.js","default_text":"Copy","success_text":"Copied"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function loadJS() {
    const els = document.querySelectorAll("#comments #giscus");
    if (els.length === 0) return;
    els.forEach((el, i) => {
      try {
        el.innerHTML = '';
      } catch (error) {
        console.log(error);
      }
      var script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.async = true;
      for (let key of Object.keys(el.attributes)) {
        let attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
    loadJS();
  });
</script>




<!-- inject -->


  </div>
</body>
</html>
